# Tests for lab 2: http://kubevirt.io/labs/kubernetes/lab2
- name: CDI lab tests
  hosts: launched
  user: centos
  become: True
  gather_facts: True
  tasks:
    # Tests for lab 2 CDI
    - name: read in lab variables
      include_vars:
        file: labs_kubernetes_variables.yml
        name: labs_vars

    - debug: var=labs_vars

    - name: create hostpath storage class
      command: kubectl apply -f {{ labs_vars.cdi_lab.storage_setup_manifest }}

    - name: create cdi
      command: kubectl apply -f {{ labs_vars.cdi_lab.cdi_controller_manifest }}

    - name: wait for cdi-deployment pod to become Running
      shell: "{{ labs_vars.cdi_lab.cdi_pod_listing_command }} | grep cdi-deployment"
      register: cdi_deployment_status
      until: cdi_deployment_status.stdout.find("Running") != -1
      retries: 30
      delay: 10

    - name: deploy fedora pvc
      command: kubectl apply -f {{ labs_vars.cdi_lab.pvc_manifest }}

    - name: wait for fedora pvc to become Bound
      shell: kubectl get pvc | grep {{ labs_vars.cdi_lab.pvc_name }}
      register: fedora_pvc_status
      until: fedora_pvc_status.stdout.find("Bound") != -1
      retries: 12
      delay: 5

    - name: wait for importer pod to start running
      shell: kubectl get pods | grep importer-{{ labs_vars.cdi_lab.pvc_name }}
      register: fedora_importer_status
      until: fedora_importer_status.stdout.find("Running") != -1
      retries: 12
      delay: 5

    - name: wait for importer pod to succeed
      shell: kubectl describe pvc {{ labs_vars.cdi_lab.pvc_name }} | grep "cdi.kubevirt.io/storage.pod.phase"
      register: fedora_importer_status
      until: fedora_importer_status.stdout.find("Succeeded") != -1
      retries: 24
      delay: 5

    - name: create fedora vm
      command: kubectl create -f {{ labs_vars.cdi_lab.vm_manifest }}

    - name: wait for fedora vm to be Running
      shell: kubectl describe vmi {{ labs_vars.cdi_lab.vm_name }} | grep Phase
      register: vm1_status
      until: vm1_status.stdout.find("Running") != -1
      retries: 30
      delay: 10

    - name: use virtctl to stop VM
      command: /home/centos/virtctl stop {{ labs_vars.cdi_lab.vm_name }}

    - name: delete vm1
      command: kubectl delete vm {{ labs_vars.cdi_lab.vm_name }}

    - name: wait for fedora vmi to be removed
      shell: kubectl get vmi
      register: vm1_status
      until: vm1_status.stderr.find("No resources") != -1
      retries: 30
      delay: 10

    - name: delete fedora pvc
      command: kubectl delete pvc {{ labs_vars.cdi_lab.pvc_name }}

    - name: wait for fedora pvc to be removed
      shell: kubectl get pvc
      register: pvc_status
      until: pvc_status.stderr.find("No resources") != -1
      retries: 30
      delay: 10

    - name: delete cdi
      command: kubectl delete -f {{ labs_vars.cdi_lab.cdi_controller_manifest }}

    - name: delete hostpath storage class
      command: kubectl delete -f {{ labs_vars.cdi_lab.storage_setup_manifest }}
