- name: run use kubevirt lab tests
  hosts: launched
  user: centos
  become: True
  gather_facts: True
  tasks:
    - name: read in lab variables
      include_vars:
        file: labs_kubernetes_variables.yml
        name: labs_vars

    - debug: var=labs_vars

    - name: create vm
      command: kubectl apply -f {{ labs_vars.use_kubevirt_lab.vm_manifest }}

    - name: use virtctl to start VM
      command: /home/centos/virtctl start {{ labs_vars.use_kubevirt_lab.vm_name }}

    - name: wait for vm to be Running
      shell: kubectl describe vmi {{ labs_vars.use_kubevirt_lab.vm_name }} | grep Phase
      register: vm_status
      until: vm_status.stdout.find("Running") != -1
      retries: 30
      delay: 10

    - name: use virtctl to stop VM
      command: /home/centos/virtctl stop  {{ labs_vars.use_kubevirt_lab.vm_name }}

    - name: wait for vmi to be removed
      shell: kubectl get vmi
      register: vm_status
      until: vm_status.stderr.find("No resources") != -1
      retries: 30
      delay: 10

    - name: cleanup vm
      command: kubectl delete -f {{ labs_vars.use_kubevirt_lab.vm_manifest }}
